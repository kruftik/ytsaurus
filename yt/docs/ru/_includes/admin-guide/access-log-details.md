Иногда возникает необходимость узнать, кто пользуется той или иной таблицей, — например, чтобы оценить последствия ее удаления или перемещения. Задача осложняется тем, что доступ может осуществляться посредством [ссылок](../../user-guide/storage/objects.md#links).

Для решения подобных задач существует специальный лог, в котором журналируются события с узлами Кипариса, которые могут представлять интерес для пользователей.

Лог пишут мастер-серверы, причем в силу технических особенностей несколько различных серверов производят одинаковую последовательность записей, так что дублирования стоит ожидать. Кроме того, некоторая активность (например, запись в таблицы) выглядит как последовательность нескольких разных событий на разных мастер-серверах (из разных шардов). Подробнее об этом далее.

Каждая запись в логе (каждая строка в таблице) фиксирует одну команду, примененную к тому или иному кипарисному узлу.

Журналируются только команды, примененные к следующим типам узлов:

* таблица;
* файл;
* документ;
* журнал.

Стоит явно отметить, что директории _не входят_ в данный перечень.

Журналируются следующие команды:

* базовые (CRUD):
  * Create
  * Get
  * GetKey
  * Exists
  * List
  * Set
  * Remove
* создание символической ссылки:
  * Link
* блокировки:
  * Lock
  * Unlock
* копирование и перемещение:
  * Copy
  * Move
  * BeginCopy, EndCopy
* чтение и запись данных:
  * GetBasicAttributes
  * Fetch
  * BeginUpload
  * EndUpload
* изменение состояния динамической таблицы:
  * PrepareMount, CommitMount, AbortMount
  * PrepareUnmount, CommitUnmount, AbortUnmount
  * PrepareRemount, CommitRemount, AbortRemount
  * PrepareFreeze, CommitFreeze, AbortFreeze
  * PrepareUnfreeze, CommitUnfreeze, AbortUnfreeze
  * PrepareReshard, CommitReshard, AbortReshard
* прочие:
  * CheckPermission

Некоторые комментарии касательно семантики команд можно найти далее.

Содержательная часть записи в логе имеет поля (колонки в таблице), представленные в таблице 1.

<small>Таблица 1 — Описание полей лога</small>

| Поле                                         | Описание                                                                                                                      |
|----------------------------------------------|-------------------------------------------------------------------------------------------------------------------------------|
| `instant`                                    | Время события в формате `YYYY-MM-DD hh:mm:ss,sss`                                                                             |
| `cluster`                                    | Короткое имя кластера                                                                                                         |
| `method`                                     | Команда (см. список выше)                                                                                                     |
| `path` (см. примечание)                      | Путь, переданный команде в качестве аргумента                                                                                 |
| `original_path` (см. примечание)             | Путь, переданный команде в качестве аргумента                                                                                 |
| `destination_path` (см. примечание)          | Для команд «Copy», «Move» и «Link» — путь назначения (для других команд отсутствует)                                          |
| `original_destination_path` (см. примечание) | Для команд «Copy», «Move» и «Link» — путь назначения (для других команд отсутствует)                                          |
| `user`                                       | Пользователь, давший команду                                                                                                  |
| `type`                                       | Для команды «Create» — тип создаваемого узла (для других команд отсутствует)                                                  |
| `transaction_info`                           | Сведения о транзакции, в контексте которой была выполнена команда (если команда выполнялась вне транзакции, поле отсутствует) |

{% note info "Примечание" %}

Отличие поля `original_path` от `path` (а также `original_destination_path` от `destination_path`) заключается в следующем:

* если в качестве пути была указана ссылка (симлинк), в `original_path` будет путь к ссылке, а в `path` — «настоящий» путь к узлу;
* далее, если этот путь ведет в шард, то в логе этого шарда в качестве `original_path` будет указан «настоящий» путь, а в качестве `path` — путь относительно корня шарда.

В общей сложности это означает, что условный grep по пути к симлинку всегда найдёт записи, содержащие настоящий путь к узлу, а grep по настоящему пути найдёт обращения в том числе и через симлинки. **Важно лишь выполнять поиск как по `path`, так и по `original_path`.**

{% endnote %}

Структура поля `transaction_info` представлена в таблице 2.

<small>Таблица 2 — Структура поля `transaction_info`</small>

| Поле                | Описание                                                                                                                            |
|---------------------|-------------------------------------------------------------------------------------------------------------------------------------|
| `transaction_id`    | ID транзакции                                                                                                                       |
| `transaction_title` | Человекочитаемое описание транзакции (указывается клиентом при запуске транзакции; поле отсутствует, если описание не было указано) |
| `operation_id`      | ID операции, ассоциированной с транзакцией                                                                                          |
| `operation_title`   | Человекочитаемое описание операции, ассоциированной с транзакцией                                                                            |
| `parent`            | Для вложенной транзакции — описание ее родителя (для верхнеуровневой транзакции поле отсутствует)                                   |

Следует отметить, что поле `parent` устроено так же, как и `transaction_info`. Таким образом, `transaction_info` содержит полное рекурсивное описание родословной транзакции, из-под которой была выполнена команда.
